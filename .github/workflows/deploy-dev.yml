name: Bundle Deploy DEV

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy_dev:
    runs-on: ubuntu-latest
    env:
      DATABRICKS_BUNDLE_ROOT: ./gam_lakehouse
    steps:
      - uses: actions/checkout@v4

      # 建议固定版本，不用 @main（随便挑一个你们允许的稳定 tag）
      - uses: databricks/setup-cli@v0.246.0

      - name: Configure Databricks CLI profile (DEV)
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST_DEV }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN_DEV }}
        run: |
          cat > ~/.databrickscfg <<EOF
          [DEV_PROFILE]
          host = $DATABRICKS_HOST
          token = $DATABRICKS_TOKEN
          EOF
          chmod 600 ~/.databrickscfg

      - name: Validate + Deploy (dev)
        shell: bash
        run: |
          echo "Using bundle root: $DATABRICKS_BUNDLE_ROOT"
          ls -la "$DATABRICKS_BUNDLE_ROOT"
          cd "$DATABRICKS_BUNDLE_ROOT"
          databricks bundle validate -t dev --profile DEV_PROFILE
          databricks bundle deploy   -t dev --profile DEV_PROFILE
