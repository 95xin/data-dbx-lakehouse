name: Bundle Deploy DEV

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy_dev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 建议固定版本，不要用 @main（避免不稳定行为）
      # 版本号你可以换成你们团队允许的稳定 tag
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@v0.246.0

      - name: Configure Databricks CLI profile (DEV)
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST_DEV }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN_DEV }}
        shell: bash
        run: |
          cat > ~/.databrickscfg <<EOF
          [DEV_PROFILE]
          host = $DATABRICKS_HOST
          token = $DATABRICKS_TOKEN
          EOF
          chmod 600 ~/.databrickscfg
          echo "Databricks DEV profile written"

      # 关键：避免外部变量污染导致 CLI 报 invalid bundle root
      - name: Ensure no bundle-root env pollution
        shell: bash
        run: |
          echo "Before unset, DATABRICKS_BUNDLE_ROOT=[$DATABRICKS_BUNDLE_ROOT]"
          unset DATABRICKS_BUNDLE_ROOT || true
          unset BUNDLE_ROOT || true
          echo "After unset,  DATABRICKS_BUNDLE_ROOT=[$DATABRICKS_BUNDLE_ROOT]"

      - name: Validate + Deploy (dev)
        shell: bash
        run: |
          echo "Repo root: $(pwd)"
          echo "List repo root:"
          ls -la

          echo "Enter bundle folder: ./gam_lakehouse"
          cd ./gam_lakehouse
          echo "Bundle folder pwd: $(pwd)"
          ls -la
          echo "databricks.yml exists?"
          test -f databricks.yml && echo "OK: databricks.yml found" || (echo "ERROR: databricks.yml missing" && exit 1)

          databricks bundle validate -t dev --profile DEV_PROFILE
          databricks bundle deploy   -t dev --profile DEV_PROFILE
