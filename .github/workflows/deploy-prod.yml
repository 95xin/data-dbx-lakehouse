name: Bundle Deploy PROD

on:
  workflow_dispatch:

jobs:
  deploy_prod:
    runs-on: ubuntu-latest
    environment: production   # 你需要在 GitHub -> Settings -> Environments 建 production，并配置 required reviewers

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 跟 dev 一样：固定版本，别用 @main
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@v0.246.0

      - name: Configure Databricks CLI profile (PROD)
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST_PROD }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN_PROD }}
        shell: bash
        run: |
          cat > ~/.databrickscfg <<EOF
          [PROD_PROFILE]
          host = $DATABRICKS_HOST
          token = $DATABRICKS_TOKEN
          EOF
          chmod 600 ~/.databrickscfg

      # 防止你之前遇到的 bundle root 污染
      - name: Ensure no bundle-root env pollution
        shell: bash
        run: |
          unset DATABRICKS_BUNDLE_ROOT || true
          unset BUNDLE_ROOT || true

      - name: Validate + Deploy (prod)
        shell: bash
        run: |
          cd ./gam_lakehouse
          databricks bundle validate -t prod --profile PROD_PROFILE
          databricks bundle deploy   -t prod --profile PROD_PROFILE
